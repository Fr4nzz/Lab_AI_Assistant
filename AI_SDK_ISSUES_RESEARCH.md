# AI SDK Integration Issues - Research & Coding Plan

> **Status: RESEARCH COMPLETE - READY FOR IMPLEMENTATION**

## Issues Reported

1. **Image rotation thumbnail not rotated** - Clicking the miniature shows unrotated image
2. **AI response not rendering** - Follow-up message response not visible until page refresh
3. **Tools not rendered on reload** - Opening same chat in new tab shows no tool cards
4. **Message duplication** - First message appears twice in new tab

## Root Cause Analysis

### Issue 1: Image Not Rotated

**Log Evidence:**
```
[imageRotation] Detected rotation: 90
[API/chat] Proxying to backend with 0 rotated images
```

**Root Cause:** Server-side rotation detection detects the rotation (90°), but `rotatedCount = 0` because:
- We don't have `sharp` library for server-side rotation
- The `processImagesForRotation` function sets `applied: false` when it can't rotate
- The file part is emitted with the **original** (unrotated) image URL

**Fix:** Either:
- A) Install `sharp` for server-side rotation
- B) Use the frontend's pre-rotated data when available
- C) Apply CSS rotation to the thumbnail display

### Issue 2: AI Response Not Rendering

**Root Cause:** When filtering out the backend's "start" event, our logic may break the stream in edge cases. The SSE parsing is fragile - if the "start" event and text content arrive in the same chunk, we might skip important data.

**Current problematic code:**
```typescript
if (skipStart) {
  const lines = text.split('\n')
  const filteredLines = lines.filter(line => {
    if (line.startsWith('data: ')) {
      // ... filtering logic
    }
    return true
  })
  // This might break partial SSE events
}
```

**Fix:** More robust stream handling that properly handles partial SSE events and doesn't break the AI SDK's message parsing.

### Issue 3: Tools Not Rendered on Reload

**Root Cause:** Looking at how we save assistant messages:

```typescript
// In /api/chats/[id].post.ts
if (fullResponse) {
  await addMessage({
    chatId,
    role: 'assistant',
    content: fullResponse  // ❌ Only saves text content!
    // Missing: parts array with tool invocations
  })
}
```

We only save the **text content**, not the full `parts` array that includes:
- `tool-invocation` parts (tool cards)
- `file` parts (rotated image thumbnails)
- `reasoning` parts (if any)

**Fix:** Save the complete message parts from the stream, not just the text.

### Issue 4: Message Duplication

**Root Cause:** We're fighting against the AI SDK's message management:

1. **We save user message in POST handler:**
```typescript
if (lastMessage?.role === 'user') {
  await addMessage({ chatId, role: 'user', content: textContent, parts: lastMessage.parts })
}
```

2. **AI SDK also tracks messages internally**

3. **When loading, messages come from DB** but AI SDK might re-add them

**AI SDK Documentation says:**
> "User message IDs are generated by the useChat hook on the client... For persistence, you need server-side generated IDs to ensure consistency."

**Fix:** Follow AI SDK's recommended approach:
- Use `onFinish` callback for saving
- Don't manually save user messages in the POST handler
- Use consistent ID generation between client and server

---

## AI SDK Best Practices We're Not Following

### 1. Message Persistence Approach

**Current (Wrong):**
```typescript
// We manually save in POST handler
await addMessage({ role: 'user', content: textContent })
// ... stream ...
await addMessage({ role: 'assistant', content: fullResponse })
```

**Recommended:**
```typescript
// Use toUIMessageStreamResponse with onFinish
return result.toUIMessageStreamResponse({
  originalMessages: messages,
  onFinish: ({ messages }) => {
    saveChat({ chatId, messages }); // Save complete UIMessages
  },
});
```

### 2. Message Format

**Current (Wrong):**
- Saving only `content` for assistant messages
- Not saving full `parts` array with tools/files

**Recommended:**
- Save complete `UIMessage` objects including `parts`
- Validate with `validateUIMessages` when loading

### 3. ID Generation

**Current:**
- Client generates random UUIDs
- Server generates different UUIDs when saving
- IDs don't match → duplicates

**Recommended:**
```typescript
// Use createIdGenerator with consistent prefix
generateMessageId: createIdGenerator({
  prefix: 'msg',
  size: 16,
})
```

### 4. Stream Protocol

**Current (Wrong):**
- Manually emitting synthetic events
- Filtering backend "start" events (fragile)
- Not using AI SDK's stream utilities

**Recommended:**
- Use `createUIMessageStream` for custom events
- Properly merge streams without filtering
- Use AI SDK's stream response utilities

---

## Coding Plan

### Phase 1: Fix Image Rotation Display (Quick Fix)

**Option A: Use frontend's pre-rotated data**

The frontend already rotates images via canvas. We should use `rotatedBase64` when available.

**File:** `server/utils/imageRotation.ts`

```typescript
// In processImagesForRotation, when frontend already rotated:
if (image.rotatedBase64 && image.rotation && image.rotation !== 0) {
  // Use the pre-rotated data from frontend
  processedImages.push({
    ...image,
    data: image.rotatedBase64,
    url: `data:${image.mediaType};base64,${image.rotatedBase64}`
  })
}
```

### Phase 2: Fix Assistant Message Persistence

**File:** `server/api/chats/[id].post.ts`

Instead of only saving text, parse and save the complete parts array:

```typescript
// Collect all parts from the stream
const messageParts: any[] = []

// When parsing stream:
if (parsed.type === 'text-delta') {
  // Accumulate text
  fullResponse += parsed.delta
}
if (parsed.type === 'tool-input-available') {
  messageParts.push({
    type: 'tool-invocation',
    toolCallId: parsed.toolCallId,
    toolName: parsed.toolName,
    state: 'call',
    args: parsed.input
  })
}
if (parsed.type === 'tool-output-available') {
  // Update existing tool part with result
}
if (parsed.type === 'file') {
  messageParts.push({
    type: 'file',
    url: parsed.url,
    mediaType: parsed.mediaType
  })
}

// Save with full parts
await addMessage({
  chatId,
  role: 'assistant',
  content: fullResponse,
  parts: [{ type: 'text', text: fullResponse }, ...messageParts]
})
```

### Phase 3: Fix Message Duplication

**Option A: Don't save user message in POST handler**

Let the frontend track messages, and only save after stream completes.

**Option B: Use consistent message IDs**

Generate message ID on server and return it to client:

```typescript
// In stream, emit the user message ID
adapter.sse({ type: 'user-message-id', id: savedUserMessageId })
```

### Phase 4: Fix Stream Composition

Instead of filtering out the backend's "start" event, properly compose streams:

**File:** `server/api/chats/[id].post.ts`

```typescript
// Don't filter - instead, tell backend to skip "start"
// OR merge streams properly using AI SDK utilities
// OR emit our synthetic events as "data parts" instead of message parts
```

---

## Implementation Priority

1. **Phase 1** - Fix rotation (affects user experience immediately)
2. **Phase 2** - Fix persistence (tools not showing is confusing)
3. **Phase 3** - Fix duplication (annoying but not blocking)
4. **Phase 4** - Stream composition (technical debt)

---

## Files to Modify

| File | Changes |
|------|---------|
| `server/utils/imageRotation.ts` | Use frontend's rotated data properly |
| `server/api/chats/[id].post.ts` | Save complete parts array, fix stream handling |
| `app/pages/chat/[id].vue` | Potentially update message initialization |

---

## Alternative Approach: Use AI SDK's Built-in Utilities

Instead of our custom streaming, consider using AI SDK's utilities:

```typescript
import { createUIMessageStream } from 'ai'

// Create a proper UI message stream
const stream = createUIMessageStream({
  onChunk: (chunk) => { /* handle */ },
  onFinish: (messages) => {
    saveChat({ chatId, messages })
  }
})
```

This would require more significant refactoring but would align better with AI SDK's design.

---

## References

- [AI SDK Message Persistence](https://ai-sdk.dev/docs/ai-sdk-ui/chatbot-message-persistence)
- [UIMessage Reference](https://ai-sdk.dev/docs/reference/ai-sdk-core/ui-message)
- [GitHub Discussion #4845](https://github.com/vercel/ai/discussions/4845) - Persistence pitfalls
- [AI SDK 5 Blog](https://vercel.com/blog/ai-sdk-5) - v5 changes
